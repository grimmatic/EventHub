<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${event.name + ' - EventHub'}">Etkinlik Detayı - EventHub</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/flowbite.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/flowbite.min.js"></script>
    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }

        .event-header {
            background: linear-gradient(to right, #3b82f6, #2563eb);
            padding: 4rem 0;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .event-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1d4ed8;
            opacity: 0.2;
        }

        .map-container {
            height: 400px;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            z-index: 1;
        }

        .leaflet-container {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem;
        }

        .chat-container {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            max-width: 80%;
        }

        .message-sent {
            background: #eff6ff;
            margin-left: auto;
            color: #1e40af;
        }

        .message-received {
            background: #f3f4f6;
            margin-right: auto;
            color: #374151;
        }

        .participant-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .stat-drivingd {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .join-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .join-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%) scale(0);
            border-radius: 50%;
            transition: transform 0.5s;
        }

        .join-button:hover::after {
            transform: translate(-50%, -50%) scale(2);
        }
        .participant-item:hover .participant-actions {
            opacity: 1;
        }

        /* Mobil görünüm için medya sorgusu */
        @media (max-width: 640px) {
            .participant-actions {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
<!-- Navigation -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<!-- Event Header -->
<div class="event-header relative">
    <div class="max-w-6xl mx-auto px-4 relative">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-4xl font-bold mb-4" th:text="${event.name}">Tech Summit 2024</h1>
                <div class="flex items-center gap-4 text-blue-100">
                        <span class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <span th:text="${#temporals.format(event.startDate, 'dd MMMM yyyy HH:mm')}">15 Aralık 2024, 10:00</span>
                        </span>
                    <span class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span th:text="${event.location}">İstanbul</span>
                        </span>
                    <span class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                            </svg>
                            <span th:text="${event.category}">Teknoloji</span>
                        </span>
                </div>
            </div>
            <div>
                <button th:if="${!isParticipant}" id="joinButton"
                        class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-lg">
                    Katıl
                </button>
                <button th:if="${isParticipant}" id="leaveButton"
                        class="bg-red-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-red-700 transition shadow-lg">
                    Etkinlikten Çık
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column -->
        <div class="lg:col-span-2">
            <!-- Event Description -->
            <div class="bg-white rounded-lg p-6 mb-8 shadow">
                <h2 class="text-2xl font-semibold mb-4">Etkinlik Detayları</h2>
                <p class="text-gray-600 mb-6" th:text="${event.description}">
                    Tech Summit 2024, teknoloji dünyasının öncü isimlerini bir araya getiriyor...
                </p>

                <!-- Event Stats -->
                <div class="stats-grid">
                    <div class="stat-drivingd">
                        <div class="text-2xl font-bold text-blue-600" th:text="${participants.size()}">150</div>
                        <div class="text-gray-600">Katılımcı</div>
                    </div>
                    <div class="stat-drivingd">
                        <div class="text-2xl font-bold text-blue-600" th:text="${duration}">4</div>
                        <div class="text-gray-600">Saat</div>
                    </div>
                    <div class="stat-drivingd">
                        <div class="text-2xl font-bold text-blue-600" th:text="${daysLeft}">3</div>
                        <div class="text-gray-600">Gün Kaldı</div>
                    </div>
                </div>
            </div>

            <!-- Location Map -->
            <div class="bg-white rounded-lg p-6 mb-8 shadow">
                <h2 class="text-2xl font-semibold mb-4">Konum</h2>

                <!-- Search Box -->
                <div class="mb-4">
                    <div class="flex gap-2">
                        <input type="text"
                               id="locationSearch"
                               placeholder="Başlangıç konumunuzu girin..."
                               class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button onclick="searchLocation()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            Ara
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">veya harita üzerine tıklayarak başlangıç noktası seçin</p>
                </div>

                <!-- Starting Location Info -->
                <div id="startingPointInfo" class="mb-4 p-3 bg-blue-50 rounded-lg hidden">
                    <p class="font-semibold">Başlangıç Noktası:</p>
                    <p id="startingPointAddress" class="text-gray-600"></p>
                </div>


                <!-- Map container -->
                <div id="map" style="height: 400px; width: 100%;"></div>


                <!-- Route info -->
                <div id="routeInfo" class="mt-2 p-3 bg-blue-50 rounded-lg hidden">
                    <p class="font-semibold">Rota Bilgileri:</p>
                    <p>Mesafe: <span id="routeDistance">-</span></p>
                    <p>Tahmini Süre: <span id="routeDuration">-</span></p>
                </div>

                <!-- Route Planning Buttons -->
                <div class="mt-4">
                    <h3 class="font-semibold mb-2">Rota Planla</h3>
                    <div class="flex gap-4">
                        <button id="drivingButton"
                                class="flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg active">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16.5c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5.448-1.5 1-1.5 1 .672 1 1.5zm8 0c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5.448-1.5 1-1.5 1 .672 1 1.5zM3.5 12h17M20 12l-2-6H6L4 12M2 12h20v4H2v-4z"/>
                            </svg>
                            Arabayla
                        </button>
                        <button id="bikeButton"
                                class="flex items-center px-4 py-2 bg-blue-50 text-blue-600 rounded-lg">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16.5c0 1.38-1.12 2.5-2.5 2.5S12 17.88 12 16.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5zm-11 0c0 1.38-1.12 2.5-2.5 2.5S1 17.88 1 16.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5zM12 8V6m-1 2l-3 6.5m11-6.5l-3 6.5M6 9h12"/>
                            </svg>
                            Bisikletle
                        </button>
                        <button id="footButton"
                                class="flex items-center px-4 py-2 bg-blue-50 text-blue-600 rounded-lg">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14h.01M16 15v-3M8 21l4-7m4 7l-4-7"/>
                            </svg>
                            Yürüyerek
                        </button>
                    </div>
                </div>
            </div>


        </div>

        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white rounded-lg p-6 shadow">
                <h2 class="text-xl font-semibold mb-4">Etkinlik Organizatörü</h2>
                <div class="flex flex-col space-y-4">
                    <!-- Organizatör Bilgileri -->
                    <div class="flex items-start space-x-4">
                        <!-- Profil Fotoğrafı ve XP -->
                        <div class="relative flex-shrink-0">
                            <img th:src="${event.creator.profileImageUrl != null ? event.creator.profileImageUrl : '/images/default-avatar.png'}"
                                 alt="Profil"
                                 class="w-16 h-16 rounded-full object-cover border-2 border-gray-200"/>
                            <div class="absolute -bottom-2 -right-2 bg-blue-500 text-white text-xs font-medium px-2 py-1 rounded-full shadow-sm">
                                <span th:text="${event.creator.totalPoints + ' Puan'}">0 Puan</span>
                            </div>
                        </div>

                        <!-- İsim ve Bilgiler -->
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold" th:text="${event.creator.firstName + ' ' + event.creator.lastName}">
                                John Doe
                            </h3>
                            <p class="text-sm text-gray-600 mb-1" th:text="${'@' + event.creator.username}">@johndoe</p>
                            <div class="flex items-center text-sm text-gray-500">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                                <span th:text="${event.creator.createdEventsCount + ' Etkinlik'}">0 Etkinlik</span>
                            </div>
                        </div>
                    </div>

                    <!-- İletişim Butonları -->
                    <div class="flex flex-col space-y-2 pt-2">
                        <button th:onclick="'window.location.href=\'/sohbet?userId=' + ${event.creator.id} + '\''"
                                class="w-full inline-flex items-center justify-center px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                            Mesaj Gönder
                        </button>
                        <a th:href="@{'/user/' + ${event.creator.id} + '/profil'}"
                           class="w-full inline-flex items-center justify-center px-4 py-2 bg-gray-50 text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            Profili Görüntüle
                        </a>
                        <button th:onclick="'viewOtherEvents(' + ${event.creator.id} + ')'"
                                class="w-full inline-flex items-center justify-center px-4 py-2 bg-gray-50 text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Diğer Etkinlikleri
                        </button>
                    </div>
                </div>
            </div>


            <div class="bg-white rounded-lg p-6 shadow">
                <h2 class="text-xl font-semibold mb-4">Katılımcılar</h2>
                <div class="participant-list divide-y divide-gray-100 max-h-[400px] overflow-y-auto">
                    <div th:each="participant : ${participants}"
                         class="participant-item py-3 hover:bg-gray-50 transition-all duration-200">
                        <div class="flex items-center gap-3">
                            <!-- Profil Resmi -->
                            <div class="flex-shrink-0">
                                <img th:src="${participant.profileImageUrl != null ? participant.profileImageUrl : '/images/default-avatar.png'}"
                                     alt="Profil"
                                     class="w-10 h-10 rounded-full object-cover border-2 border-gray-200"/>
                            </div>
                            <!-- Kullanıcı Bilgileri -->
                            <div class="flex-grow min-w-0">
                                <p class="font-medium text-gray-900 truncate"
                                   th:text="${participant.firstName + ' ' + participant.lastName}">
                                </p>
                                <p class="text-sm text-gray-500 truncate"
                                   th:text="${participant.username}">
                                </p>
                            </div>
                            <!-- İşlem Butonları -->
                            <div class="flex items-center gap-2">
                                <!-- Profili Görüntüle Butonu -->
                                <a th:href="@{'/user/' + ${participant.id} + '/profil'}"
                                   class="flex items-center px-3 py-1.5 text-sm text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                   title="Profili Görüntüle">
                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    Profil
                                </a>
                                <!-- Mesaj Gönder Butonu -->
                                <button th:onclick="'window.location.href=\'/sohbet?userId=' + ${participant.id} + '\''"
                                        class="flex items-center px-3 py-1.5 text-sm text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                        title="Mesaj Gönder">
                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                    </svg>
                                    Mesaj
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="lg:col-span-3">

            <div th:if="${isParticipant}" class="chat-container">
                <div class="p-4 bg-blue-50 border-b">
                    <h2 class="text-xl font-semibold">Etkinlik Sohbeti</h2>
                </div>
                <div class="chat-messages" id="chatMessages">

                </div>
                <div class="p-4 border-t">
                    <div class="flex gap-2">
                        <input type="text" class="flex-1 p-2 border rounded-lg" placeholder="Mesajınızı yazın...">
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>




    </div>

    <div class="bg-white rounded-lg p-6 shadow">
        <h2 class="text-xl font-semibold mb-6">Benzer Etkinlikler</h2>
        <div class="grid gap-4">
            <a th:each="similarEvent : ${similarEvents}"
               th:href="@{'/event/' + ${similarEvent.id}}"
               class="group block bg-white rounded-lg overflow-hidden transition-all duration-300 hover:shadow-lg border border-gray-100 hover:border-blue-200">
                <div class="flex items-center p-4">
                    <div class="relative w-20 h-20 flex-shrink-0">

                        <img th:src="@{'/images/categories/' + ${similarEvent.category.toLowerCase()} + '.jpg'}"
                             th:alt="${similarEvent.category}"
                             class="rounded-lg object-cover w-full h-full">


                    </div>

                    <div class="ml-4 flex-grow">
                        <h3 class="font-medium text-gray-900 group-hover:text-blue-600 transition-colors duration-200"
                            th:text="${similarEvent.name}">Benzer Etkinlik</h3>

                        <!-- Tarih ve Konum -->
                        <div class="mt-1 space-y-1">
                            <div class="flex items-center text-sm text-gray-500">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <span th:text="${#temporals.format(similarEvent.startDate, 'dd MMM yyyy, HH:mm')}">
                                Tarih
                            </span>
                            </div>

                            <div class="flex items-center text-sm text-gray-500">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                </svg>
                                <span th:text="${similarEvent.location}" class="truncate">Konum</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sağ ok ikonu -->
                    <div class="text-gray-400 group-hover:text-blue-500 transition-colors duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                </div>
            </a>
        </div>
    </div>
</div>
</body>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const joinButton = document.getElementById('joinButton');

        if (joinButton) {
            joinButton.addEventListener('click', async function() {
                try {
                    const eventId = window.location.pathname.split('/').pop();
                    const response = await fetch(`/event/join/${eventId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        // Butonu güncelle
                        joinButton.textContent = 'Katıldınız';
                        joinButton.classList.remove('bg-white', 'text-blue-600');
                        joinButton.classList.add('bg-green-500', 'text-white');
                        joinButton.disabled = true;

                        // Sayfayı yenile
                        window.location.reload();
                    } else {
                        alert(result.message || 'Bir hata oluştu');
                    }
                } catch (error) {
                    console.error('Hata:', error);
                    alert('Bir hata oluştu: ' + error.message);
                }
            });
        }
    });

    // Chat functionality
    const chatInput = document.querySelector('.chat-container input');
    const sendButton = document.querySelector('.chat-container button');

    function getEventIdFromUrl() {
        const path = window.location.pathname;
        const eventId = path.split('/').pop();
        return eventId;
    }
    async function loadMessageHistory() {
        const eventId = getEventIdFromUrl();
        try {
            const response = await fetch(`/event/chat-messages?eventId=${eventId}`); // URL'i güncelle
            if (!response.ok) {
                throw new Error('Failed to load messages');
            }
            const messages = await response.json();
            displayMessages(messages);
        } catch (error) {
            console.error('Error loading messages:', error);
            alert('Mesaj geçmişi yüklenirken bir hata oluştu.');
        }
    }
    function displayMessages(messages) {
        chatMessages.innerHTML = ''; // Mevcut mesajları temizle

        messages.forEach(message => {
            const messageHtml = createMessageHTML(message);
            chatMessages.insertAdjacentHTML('beforeend', messageHtml);
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function createMessageHTML(message) {
        const time = new Date(message.timestamp).toLocaleTimeString();
        const profileImage = message.profileImageUrl || '/images/default-avatar.png';

        if (message.currentUser) {
            return `
            <div class="message message-sent">
                <div class="flex items-start justify-end">
                    <div class="text-right">
                        <div class="font-semibold text-sm">Sen</div>
                        <div class="bg-blue-500 text-white rounded-lg py-2 px-4 max-w-md">
                            ${message.message}
                        </div>
                        <div class="text-xs text-gray-500 mt-1">${time}</div>
                    </div>
                    <img src="${profileImage}"
                         alt="Profil"
                         class="w-8 h-8 rounded-full ml-3 object-cover">
                </div>
            </div>
        `;
        } else {
            return `
            <div class="message message-received">
                <div class="flex items-start">
                    <img src="${profileImage}"
                         alt="Profil"
                         class="w-8 h-8 rounded-full mr-3 object-cover">
                    <div>
                        <div class="font-semibold text-sm">${message.firstName} ${message.lastName}</div>
                        <div class="bg-gray-200 rounded-lg py-2 px-4 max-w-md">
                            ${message.message}
                        </div>
                        <div class="text-xs text-gray-500 mt-1">${time}</div>
                    </div>
                </div>
            </div>
        `;
        }
    }

    // Mesaj gönderme fonksiyonu
    async function sendMessageToBackend(message) {
        const eventId = getEventIdFromUrl();

        try {
            const response = await fetch(`/event/send-message?message=${encodeURIComponent(message)}&eventId=${eventId}`, { // URL'i güncelle
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (!response.ok) {
                throw new Error('Message sending failed');
            }

            const messageData = await response.json();
            return messageData;
        } catch (error) {
            console.error('Error sending message:', error);
            throw error;
        }
    }
    function viewOtherEvents(userId) {
        // Profil sayfasına yönlendir ve events sekmesini aç
        window.location.href = `/user/${userId}/profil?tab=events`;
    }
    // Chat UI ve mesaj gönderme mantığı
    if (chatInput && sendButton) {
        // Sayfa yüklendiğinde mesaj geçmişini yükle
        document.addEventListener('DOMContentLoaded', loadMessageHistory);

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                try {
                    const sentMessage = await sendMessageToBackend(message);
                    const messageHtml = createMessageHTML({
                        ...sentMessage,
                        currentUser: true
                    });

                    chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                    chatInput.value = '';
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } catch (error) {
                    alert('Mesaj gönderilemedi. Lütfen tekrar deneyin.');
                }
            }
        }

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    }

    const leaveButton = document.getElementById('leaveButton');
    if (leaveButton) {
        leaveButton.addEventListener('click', async function() {
            if (confirm('Bu etkinlikten çıkmak istediğinize emin misiniz? Kazandığınız puanlar geri alınacaktır.')) {
                try {
                    const eventId = window.location.pathname.split('/').pop();
                    const response = await fetch(`/event/leave/${eventId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        window.location.reload();
                    } else {
                        alert(result.message || 'Bir hata oluştu');
                    }
                } catch (error) {
                    console.error('Hata:', error);
                    alert('Bir hata oluştu: ' + error.message);
                }
            }
        });
    }
</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script th:inline="javascript">
    let map, startMarker, endMarker, routeLayer;
    let startPoint = null;
    let currentEventMarker = null;
    let otherEventMarkers = {};

    function openChatModal() {

        window.location.href = "http://localhost:8080/sohbet";
    }
    function startChat(userId) {
        window.location.href = `/sohbet?userId=${userId}`;
    }

    const eventLocation = /*[[${location}]]*/ { latitude: 0, longitude: 0 };
    const eventName = /*[[${event.name}]]*/ 'Event';
    const otherEvents = /*[[${otherEventLocations}]]*/ [];
    const eventId = /*[[${event.id}]]*/ 0;

    const currentEventIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        shadowSize: [41, 41]
    });

    const otherEventIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        shadowSize: [41, 41]
    });

    const startIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        shadowSize: [41, 41]
    });

    function initMap() {
        // Harita başlangıç ayarları
        map = L.map('map').setView([eventLocation.latitude, eventLocation.longitude], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Event değişkenlerini Thymeleaf'ten al
        const eventStartDate = /*[[${event.startDate}]]*/ '';
        const eventDescription = /*[[${event.description}]]*/ '';

        // Mevcut etkinlik marker'ı
        currentEventMarker = L.marker([eventLocation.latitude, eventLocation.longitude], {
            icon: currentEventIcon
        })
            .addTo(map)
            .bindPopup(`
            <div class="p-2">
                <h3 class="font-bold text-lg mb-2">${eventName}</h3>
                <div class="flex items-center text-gray-600 text-sm mb-2">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    ${new Date(eventStartDate).toLocaleString('tr-TR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}
                </div>
                <p class="text-gray-600 text-sm mb-3" style="max-height: 80px; overflow-y: auto;">
                    ${eventDescription}
                </p>
                <button onclick="setDestination(${eventLocation.latitude}, ${eventLocation.longitude}, '${eventName}')"
                        class="w-full px-3 py-1.5 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors">
                    Buraya Git
                </button>
            </div>
        `);

        // Diğer etkinliklerin marker'larını ekle
        if (otherEvents && otherEvents.length > 0) {
            otherEvents.forEach(event => {
                const popupContent = `
                <div class="p-2">
                    <h3 class="font-bold text-lg mb-2">${event.name}</h3>
                    <div class="flex items-center text-gray-600 text-sm mb-2">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        ${new Date(event.startDate).toLocaleString('tr-TR', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}
                    </div>
                    <p class="text-gray-600 text-sm mb-3" style="max-height: 80px; overflow-y: auto;">
                        ${event.description}
                    </p>
                    <button onclick="setDestination(${event.latitude}, ${event.longitude}, '${event.name}')"
                            class="w-full px-3 py-1.5 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors">
                        Buraya Git
                    </button>
                </div>
            `;

                const marker = L.marker([event.latitude, event.longitude], {
                    icon: otherEventIcon
                })
                    .addTo(map)
                    .bindPopup(popupContent, {
                        maxWidth: 300
                    });

                const key = `${event.latitude},${event.longitude}`;
                if (!otherEventMarkers[key]) {
                    otherEventMarkers[key] = [];
                }
                otherEventMarkers[key].push(marker);
            });
        }

        // Haritaya tıklama olayını dinle
        map.on('click', function(e) {
            setStartingPoint(e.latlng.lat, e.latlng.lng);
        });

        // Arama kutusu için geocoder ekle
        const searchControl = L.Control.geocoder({
            defaultMarkGeocode: false,
            geocoder: L.Control.Geocoder.nominatim({
                geocodingQueryParams: {
                    countrycodes: 'tr',
                    limit: 5
                }
            })
        })
            .on('markgeocode', function(e) {
                const latlng = e.geocode.center;
                setStartingPoint(latlng.lat, latlng.lng, e.geocode.name);
                map.setView(latlng, 13);
            })
            .addTo(map);
    }

    function setStartingPoint(lat, lng, address = null) {
        // Varsa eski marker'ı kaldır
        if (startMarker) {
            map.removeLayer(startMarker);
        }

        // Yeni başlangıç marker'ı ekle
        startMarker = L.marker([lat, lng], {
            draggable: true,
            icon: startIcon  // Yeşil ikon kullan
        }).addTo(map);

        startPoint = [lat, lng];

        // Marker sürüklendiğinde konumu güncelle
        startMarker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            setStartingPoint(pos.lat, pos.lng);
        });

        // Başlangıç noktası bilgisini göster
        const startingPointInfo = document.getElementById('startingPointInfo');
        const startingPointAddress = document.getElementById('startingPointAddress');

        startingPointInfo.classList.remove('hidden');

        if (address) {
            startingPointAddress.textContent = address;
        } else {
            reverseGeocode(lat, lng);
        }

        enableRouteButtons();
    }

    function setDestination(lat, lng, name) {
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }

        // Varış noktası koordinatlarını kaydet
        endMarker = [lng, lat];

        if (startPoint) {
            // Tüm ulaşım modu butonlarını seç
            const transportButtons = document.querySelectorAll('#drivingButton, #bikeButton, #footButton');

            // Aktif butonu bul
            const activeButton = Array.from(transportButtons).find(button =>
                button.classList.contains('active')
            );


            const activeMode = activeButton
                ? activeButton.id.replace('Button', '')
                : 'driving';

            calculateRoute(activeMode);
        }else {
            alert('Lütfen önce başlangıç noktası seçin');
        }
    }

    // Ulaşım modu butonlarını güncelle
    document.getElementById('drivingButton').addEventListener('click', function() {
        setActiveButton(this);
        if (startPoint && endMarker) calculateRoute('driving');
    });

    document.getElementById('bikeButton').addEventListener('click', function() {
        setActiveButton(this);
        if (startPoint && endMarker) calculateRoute('bike');
    });

    document.getElementById('footButton').addEventListener('click', function() {
        setActiveButton(this);
        if (startPoint && endMarker) calculateRoute('foot');
    });

    function setActiveButton(button) {
        // Tüm butonlardan aktif sınıfı ve stilleri kaldır
        const allButtons = document.querySelectorAll('#drivingButton, #bikeButton, #footButton');

        allButtons.forEach(btn => {
            btn.classList.remove('active');
            btn.classList.remove('bg-blue-500');
            btn.classList.remove('text-white');
            btn.classList.add('bg-blue-50');
            btn.classList.add('text-blue-600');
        });

        // Seçilen butonu aktif yap
        button.classList.add('active');
        button.classList.remove('bg-blue-50');
        button.classList.remove('text-blue-600');
        button.classList.add('bg-blue-500');
        button.classList.add('text-white');
    }

    document.getElementById('locationSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchLocation();
        }
    });
    function searchLocation() {
        const searchInput = document.getElementById('locationSearch');
        const searchText = searchInput.value.trim();

        if (!searchText) return;

        // Nominatim API'si ile arama yap
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchText)}&countrycodes=tr&limit=1`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const location = data[0];
                    setStartingPoint(
                        parseFloat(location.lat),
                        parseFloat(location.lon),
                        location.display_name
                    );
                    map.setView([location.lat, location.lon], 13);
                } else {
                    alert('Konum bulunamadı');
                }
            })
            .catch(error => {
                console.error('Arama hatası:', error);
                alert('Arama sırasında bir hata oluştu');
            });
    }

    function reverseGeocode(lat, lng) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    document.getElementById('startingPointAddress').textContent = data.display_name;
                }
            })
            .catch(error => {
                console.error('Reverse geocoding hatası:', error);
                document.getElementById('startingPointAddress').textContent = `${lat}, ${lng}`;
            });
    }

    function calculateRoute(mode) {
        if (!startPoint || !endMarker) {
            alert('Lütfen başlangıç ve varış noktalarını seçin');
            return;
        }

        const modeConfig = {
            car: {
                profile: 'driving-car',
                color: '#3388ff',
                weight: 6,
                opacity: 0.8,
                dashArray: null
            },
            bike: {
                profile: 'cycling-regular',
                color: '#33cc33',
                weight: 5,
                opacity: 0.8,
                dashArray: '12, 8'
            },
            foot: {
                profile: 'foot-walking',
                color: '#ff3333',
                weight: 4,
                opacity: 0.8,
                dashArray: '8, 8'
            }
        };

        const config = modeConfig[mode] || modeConfig.car;
        const baseUrl = 'https://api.openrouteservice.org/v2/directions';
        const apiKey = '5b3ce3597851110001cf624862745c92428f4b5b915aa478e6cd612c';

        const url = `${baseUrl}/${config.profile}/geojson`;

        const body = {
            coordinates: [
                [startPoint[1], startPoint[0]],
                [endMarker[0], endMarker[1]]
            ],
            language: 'tr'
        };


        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': apiKey
            },
            body: JSON.stringify(body)
        })
            .then(response => response.json())
            .then(data => {
                if (data.features && data.features.length > 0) {
                    if (routeLayer) {
                        map.removeLayer(routeLayer);
                    }

                    routeLayer = L.geoJSON(data.features[0], {
                        style: {
                            color: config.color,
                            weight: config.weight,
                            opacity: config.opacity,
                            dashArray: config.dashArray,
                            lineCap: 'round',
                            lineJoin: 'round'
                        }
                    }).addTo(map);

                    const properties = data.features[0].properties;
                    updateRouteInfo({
                        distance: properties.segments[0].distance,
                        duration: properties.segments[0].duration
                    }, mode);

                    map.fitBounds(routeLayer.getBounds(), {
                        padding: [50, 50]
                    });
                }
            })
            .catch(error => {
                console.error('Rota hesaplama hatası:', error);
                alert('Rota hesaplanırken bir hata oluştu');
            });
    }


    function enableRouteButtons() {
        document.getElementById('drivingButton').disabled = false;
        document.getElementById('bikeButton').disabled = false;
        document.getElementById('footButton').disabled = false;
    }
    function updateRouteInfo(route, mode) {
        const distance = (route.distance / 1000).toFixed(1);
        let duration = route.duration / 60;

        let modeText;
        switch(mode) {
            case 'driving':
                modeText = 'Arabayla';
                break;
            case 'bike':
                modeText = 'Bisikletle';
                break;
            case 'foot':
                modeText = 'Yürüyerek';
                break;
            default:
                modeText = '';
        }

        let durationText;
        if (duration > 60) {
            const hours = Math.floor(duration / 60);
            const minutes = Math.round(duration % 60);
            durationText = `${hours} saat ${minutes} dakika`;
        } else {
            durationText = `${Math.round(duration)} dakika`;
        }

        document.getElementById('routeInfo').classList.remove('hidden');
        document.getElementById('routeDistance').textContent = `${distance} km`;
        document.getElementById('routeDuration').textContent = `${modeText} ${durationText}`;


    }


    document.addEventListener('DOMContentLoaded', initMap);
</script>
</html>